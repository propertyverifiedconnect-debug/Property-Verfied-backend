steps:
  - name: 'gcr.io/cloud-builders/docker'
    args:
      [
        'build',
        '-t',
        '${_REGION}-docker.pkg.dev/${_PROJECT_ID}/${_REPO_NAME}/${_IMAGE_NAME}:latest',
        './backend',
        '-f',
        './backend/Dockerfile',
      ]
    id: 'Build Image'

  - name: 'gcr.io/cloud-builders/docker'
    args: ['push', '${_REGION}-docker.pkg.dev/${_PROJECT_ID}/${_REPO_NAME}/${_IMAGE_NAME}:latest']
    id: 'Push Image'
    waitFor: ['Build Image']

  - name: 'gcr.io/google-cloud-sdk/gcloud'
    entrypoint: gcloud
    args:
      [
        'run',
        'deploy',
        '${_SERVICE_NAME}',
        '--image=${_REGION}-docker.pkg.dev/${_PROJECT_ID}/${_REPO_NAME}/${_IMAGE_NAME}:latest',
        '--region',
        '${_REGION}',
        '--platform',
        'managed',
        '--allow-unauthenticated',
        '--set-env-vars=SUPABASE_URL="https://flwdkuhwdegwwnqxwmvl.supabase.co", SUPABASE_SERVICE_ROLE_KEY="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImZsd2RrdWh3ZGVnd3ducXh3bXZsIiwicm9sZSI6InNlcnZpY2Vfcm9sZSIsImlhdCI6MTc2MTM5OTI0NiwiZXhwIjoyMDc2OTc1MjQ2fQ.wpCGw0_iF9eCMNYhYC7cn_dfY6bQCgN-To4jHHxWA8k", JWT_SECRET="some_random_secret", PORT="5000", CORS_URL="http://localhost:8000"',
      ]
    id: 'Deploy to Cloud Run'
    waitFor: ['Push Image']

images:
  - '${_REGION}-docker.pkg.dev/${_PROJECT_ID}/${_REPO_NAME}/${_IMAGE_NAME}:latest'

options:
  logging: CLOUD_LOGGING_ONLY